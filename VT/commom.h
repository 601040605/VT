#pragma once

#define 	EXIT_REASON_EXCEPTION_NMI   0 
#define 	EXIT_REASON_EXTERNAL_INTERRUPT   1 
#define 	EXIT_REASON_TRIPLE_FAULT   2 
#define 	EXIT_REASON_INIT   3 
#define 	EXIT_REASON_SIPI   4 
#define 	EXIT_REASON_IO_SMI   5 
#define 	EXIT_REASON_OTHER_SMI   6 
#define 	EXIT_REASON_PENDING_VIRT_INTR   7 
#define 	EXIT_REASON_PENDING_VIRT_NMI   8 
#define 	EXIT_REASON_TASK_SWITCH   9 
#define 	EXIT_REASON_CPUID   10 
#define 	EXIT_REASON_GETSEC   11 
#define 	EXIT_REASON_HLT   12 
#define 	EXIT_REASON_INVD   13 
#define 	EXIT_REASON_INVLPG   14 
#define 	EXIT_REASON_RDPMC   15 
#define 	EXIT_REASON_RDTSC   16 
#define 	EXIT_REASON_RSM   17 
#define 	EXIT_REASON_VMCALL   18 
#define 	EXIT_REASON_VMCLEAR   19 
#define 	EXIT_REASON_VMLAUNCH   20 
#define 	EXIT_REASON_VMPTRLD   21 
#define 	EXIT_REASON_VMPTRST   22 
#define 	EXIT_REASON_VMREAD   23 
#define 	EXIT_REASON_VMRESUME   24 
#define 	EXIT_REASON_VMWRITE   25 
#define 	EXIT_REASON_VMXOFF   26 
#define 	EXIT_REASON_VMXON   27 
#define 	EXIT_REASON_CR_ACCESS   28 
#define 	EXIT_REASON_DR_ACCESS   29 
#define 	EXIT_REASON_IO_INSTRUCTION   30 
#define 	EXIT_REASON_MSR_READ   31 
#define 	EXIT_REASON_MSR_WRITE   32 
#define 	EXIT_REASON_INVALID_GUEST_STATE   33 
#define 	EXIT_REASON_MSR_LOADING   34 
#define 	EXIT_REASON_UNDEFINED_1   35 
#define 	EXIT_REASON_MWAIT_INSTRUCTION   36 
#define 	EXIT_REASON_MONITOR_TRAP_FLAG   37 
#define 	EXIT_REASON_UNDEFINED_2   38 
#define 	EXIT_REASON_MONITOR_INSTRUCTION   39 
#define 	EXIT_REASON_PAUSE_INSTRUCTION   40 
#define 	EXIT_REASON_MCE_DURING_VMENTRY   41 
#define 	EXIT_REASON_UNDEFINED_3   42 
#define 	EXIT_REASON_TPR_BELOW_THRESHOLD   43 
#define 	EXIT_REASON_APIC_ACCESS   44 
#define 	EXIT_REASON_EOI_INDUCED   45 
#define 	EXIT_REASON_ACCESS_GDTR_OR_IDTR   46 
#define 	EXIT_REASON_ACCESS_LDTR_OR_TR   47 
#define 	EXIT_REASON_EPT_VIOLATION   48 
#define 	EXIT_REASON_EPT_MISCONFIG   49 
#define 	EXIT_REASON_INVEPT   50 
#define 	EXIT_REASON_RDTSCP   51 
#define 	EXIT_REASON_VMX_PREEMPTION_TIMER_EXPIRED   52 
#define 	EXIT_REASON_INVVPID   53 
#define 	EXIT_REASON_WBINVD   54 
#define 	EXIT_REASON_XSETBV   55 
#define 	EXIT_REASON_APIC_WRITE   56 
#define 	EXIT_REASON_RDRAND   57 
#define 	EXIT_REASON_INVPCID   58 
#define 	EXIT_REASON_VMFUNC   59 
#define 	EXIT_REASON_UNDEFINED_4   60 
#define 	EXIT_REASON_RDSEED   61 
#define 	EXIT_REASON_UNDEFINED_5   62 
#define 	EXIT_REASON_XSAVES   63 
#define 	EXIT_REASON_XRSTORS   64 
#define 	VMX_MAX_GUEST_VMEXIT 










#define MSR_IA32_SYSENTER_CS 0x174
#define MSR_IA32_SYSENTER_ESP  0x175
#define MSR_IA32_SYSENTER_EIP  0x176
#define MSR_IA32_DEBUGCTL  0x1d9
#define MSR_EFER  0xc0000080

/*ULONG MSR_IA32_VMX_TRUE_PINBASED_CTLS = 0x48d;
ULONG MSR_IA32_VMX_TRUE_PROCBASED_CTLS = 0x48e;
ULONG MSR_IA32_VMX_TRUE_EXIT_CTLS = 0x48f;
ULONG MSR_IA32_VMX_TRUE_ENTRY_CTLS = 0x490;*/    //true寄存器 在驱动中已经判断了

/* x86-64 MSR */



#define MSR_FS_BASE 0xc0000100       
#define MSR_GS_BASE 0xc0000101     
#define MSR_SHADOW_GS_BASE 0xc0000102 

# define VMX_CONTROL_REG_ACCESS_TYPE_MOV_TO_CR   0
# define VMX_CONTROL_REG_ACCESS_TYPE_MOV_FROM_CR 1
# define VMX_CONTROL_REG_ACCESS_TYPE_CLTS        2
# define VMX_CONTROL_REG_ACCESS_TYPE_LMSW        3



#define KGDT64_NULL (0 * 16)    // NULL descriptor
#define KGDT64_R0_CODE (1 * 16) // kernel mode 64-bit code
#define KGDT64_R0_DATA (1 * 16) + 8     // kernel mode 64-bit data (stack)
#define KGDT64_R3_CMCODE (2 * 16)       // user mode 32-bit code
#define KGDT64_R3_DATA (2 * 16) + 8     // user mode 32-bit data
#define KGDT64_R3_CODE (3 * 16) // user mode 64-bit code
#define KGDT64_SYS_TSS (4 * 16) // kernel mode system task state
#define KGDT64_R3_CMTEB (5 * 16)        // user mode 32-bit TEB
#define KGDT64_R0_CMCODE (6 * 16)       // kernel mode 32-bit code



#define MovToCr 0
#define MovFromCr 1
#define CLTSoperator 2
#define LMSWoperator 3





#define	VIRTUAL_PROCESSOR_ID     0x00000000
#define	POSTED_INTR_NV     0x00000002
#define	GUEST_ES_SELECTOR     0x00000800
#define	GUEST_CS_SELECTOR     0x00000802
#define	GUEST_SS_SELECTOR     0x00000804
#define	GUEST_DS_SELECTOR     0x00000806
#define	GUEST_FS_SELECTOR     0x00000808
#define	GUEST_GS_SELECTOR    0x0000080A
#define	GUEST_LDTR_SELECTOR     0x0000080c
#define	GUEST_TR_SELECTOR     0x0000080e
#define	GUEST_INTR_STATUS     0x00000810
#define	HOST_ES_SELECTOR     0x00000c00
#define	HOST_CS_SELECTOR     0x00000c02
#define	HOST_SS_SELECTOR     0x00000c04
#define	HOST_DS_SELECTOR     0x00000c06
#define	HOST_FS_SELECTOR     0x00000c08
#define	HOST_GS_SELECTOR     0x00000c0a
#define	HOST_TR_SELECTOR     0x00000c0c
#define	IO_BITMAP_A_ADDRESS     0x00002000
#define	IO_BITMAP_A_HIGH_ADDRESS     0x00002001
#define	IO_BITMAP_B_ADDRESS     0x00002002
#define	IO_BITMAP_B_HIGH_ADDRESS     0x00002003
#define	MSR_BITMAP_address     0x00002004
#define	MSR_BITMAP_HIGH     0x00002005
#define	VM_EXIT_MSR_STORE_ADDR     0x00002006
#define	VM_EXIT_MSR_STORE_ADDR_HIGH     0x00002007
#define	VM_EXIT_MSR_LOAD_ADDR     0x00002008
#define	VM_EXIT_MSR_LOAD_ADDR_HIGH     0x00002009
#define	VM_ENTRY_MSR_LOAD_ADDR     0x0000200a
#define	VM_ENTRY_MSR_LOAD_ADDR_HIGH     0x0000200b
#define	TSC_OFFSET     0x00002010
#define	TSC_OFFSET_HIGH     0x00002011
#define	virtual_APIC_address     0x00002012
#define	VIRTUAL_APIC_PAGE_ADDR_HIGH     0x00002013
#define	APIC_access_address     0x00002014
#define	APIC_ACCESS_ADDR_HIGH     0x00002015
#define	POSTED_INTR_DESC_ADDR     0x00002016
#define	POSTED_INTR_DESC_ADDR_HIGH     0x00002017
#define   VM_function_control     0x2018
#define	EPT_POINTER     0x0000201a
#define	EPT_POINTER_HIGH     0x0000201b
#define	EOI_EXIT_BITMAP0     0x0000201c
#define	EOI_EXIT_BITMAP0_HIGH     0x0000201d
#define	EOI_EXIT_BITMAP1     0x0000201e
#define	EOI_EXIT_BITMAP1_HIGH     0x0000201f
#define	EOI_EXIT_BITMAP2     0x00002020
#define	EOI_EXIT_BITMAP2_HIGH     0x00002021
#define	EOI_EXIT_BITMAP3     0x00002022
#define	EOI_EXIT_BITMAP3_HIGH     0x00002023
#define	VMREAD_BITMAP     0x00002026
#define	VMWRITE_BITMAP     0x00002028
#define	XSS_EXIT_BITMAP     0x0000202C
#define	XSS_EXIT_BITMAP_HIGH     0x0000202D
#define	GUEST_PHYSICAL_ADDRESS     0x00002400
#define	GUEST_PHYSICAL_ADDRESS_HIGH     0x00002401
#define	VMCS_LINK_POINTER     0x00002800
#define	VMCS_LINK_POINTER_HIGH     0x00002801
#define	GUEST_IA32_DEBUGCTL     0x00002802
#define	GUEST_IA32_DEBUGCTL_HIGH     0x00002803
#define	GUEST_IA32_PAT     0x00002804
#define	GUEST_IA32_PAT_HIGH     0x00002805
#define	GUEST_IA32_EFER     0x00002806
#define	GUEST_IA32_EFER_HIGH     0x00002807
#define	GUEST_IA32_PERF_GLOBAL_CTRL     0x00002808
#define	GUEST_IA32_PERF_GLOBAL_CTRL_HIGH     0x00002809
#define	GUEST_PDPTR0     0x0000280a
#define	GUEST_PDPTR0_HIGH     0x0000280b
#define	GUEST_PDPTR1     0x0000280c
#define	GUEST_PDPTR1_HIGH     0x0000280d
#define	GUEST_PDPTR2     0x0000280e
#define	GUEST_PDPTR2_HIGH     0x0000280f
#define	GUEST_PDPTR3     0x00002810
#define	GUEST_PDPTR3_HIGH     0x00002811
#define	GUEST_BNDCFGS     0x00002812
#define	GUEST_BNDCFGS_HIGH     0x00002813
#define	HOST_IA32_PAT     0x00002c00
#define	HOST_IA32_PAT_HIGH     0x00002c01
#define	HOST_IA32_EFER     0x00002c02
#define	HOST_IA32_EFER_HIGH     0x00002c03
#define	HOST_IA32_PERF_GLOBAL_CTRL     0x00002c04
#define	HOST_IA32_PERF_GLOBAL_CTRL_HIGH     0x00002c05
#define	PIN_BASED_VM_EXEC_CONTROL     0x00004000
#define	Primary_processor_based_VM_execution_controls     0x00004002
#define	EXCEPTION_BITMAP     0x00004004
#define	PAGE_FAULT_ERROR_CODE_MASK     0x00004006
#define	PAGE_FAULT_ERROR_CODE_MATCH     0x00004008
#define	CR3_TARGET_COUNT     0x0000400a
#define	VM_EXIT_CONTROLS     0x0000400c
#define	VM_EXIT_MSR_STORE_COUNT     0x0000400e
#define	VM_EXIT_MSR_LOAD_COUNT     0x00004010
#define	VM_ENTRY_CONTROLS     0x00004012
#define	VM_ENTRY_MSR_LOAD_COUNT     0x00004014
#define	VM_ENTRY_INTRRUPTION_INFORMATION_FIELD     0x00004016
#define	VM_ENTRY_EXCEPTION_ERROR_CODE     0x00004018
#define	VM_ENTRY_INSTRUCTION_LEN     0x0000401a
#define	TPR_THRESHOLD     0x0000401c
#define	Secondary_processor_based_VM_execution_controls     0x0000401e
#define	PLE_GAP     0x00004020
#define	PLE_WINDOW     0x00004022
#define	VM_INSTRUCTION_ERROR     0x00004400
#define	VM_EXIT_REASON     0x00004402
#define	VM_EXIT_INTR_INFO     0x00004404
#define	VM_EXIT_INTR_ERROR_CODE     0x00004406
#define	IDT_VECTORING_INFO_FIELD     0x00004408
#define	IDT_VECTORING_ERROR_CODE     0x0000440a
#define	VM_EXIT_INSTRUCTION_LEN     0x0000440c
#define	VMX_INSTRUCTION_INFO     0x0000440e
#define	GUEST_ES_LIMIT     0x00004800
#define	GUEST_CS_LIMIT     0x00004802
#define	GUEST_SS_LIMIT     0x00004804
#define	GUEST_DS_LIMIT     0x00004806
#define	GUEST_FS_LIMIT     0x00004808
#define	GUEST_GS_LIMIT     0x0000480A
#define	GUEST_LDTR_LIMIT     0x0000480c
#define	GUEST_TR_LIMIT     0x0000480e
#define	GUEST_GDTR_LIMIT     0x00004810
#define	GUEST_IDTR_LIMIT     0x00004812
#define	GUEST_ES_AR_BYTES     0x00004814
#define	GUEST_CS_AR_BYTES     0x00004816
#define	GUEST_SS_AR_BYTES     0x00004818
#define	GUEST_DS_AR_BYTES     0x0000481a
#define	GUEST_FS_AR_BYTES     0x0000481c
#define	GUEST_GS_AR_BYTES     0x0000481e
#define	GUEST_LDTR_AR_BYTES     0x00004820
#define	GUEST_TR_AR_BYTES     0x00004822
#define	GUEST_INTERRUPTIBILITY_INFO     0x00004824
#define	GUEST_ACTIVITY_STATE     0X00004826
#define	GUEST_SYSENTER_CS     0x0000482A
#define	VMX_PREEMPTION_TIMER_VALUE     0x0000482E
#define	HOST_IA32_SYSENTER_CS     0x00004c00
#define	CR0_GUEST_HOST_MASK     0x00006000
#define	CR4_GUEST_HOST_MASK     0x00006002
#define	CR0_READ_SHADOW     0x00006004
#define	CR4_READ_SHADOW     0x00006006
#define	CR3_TARGET_VALUE0     0x00006008
#define	CR3_TARGET_VALUE1     0x0000600a
#define	CR3_TARGET_VALUE2     0x0000600c
#define	CR3_TARGET_VALUE3     0x0000600e
#define	EXIT_QUALIFICATION     0x00006400
#define	GUEST_LINEAR_ADDRESS     0x0000640a
#define	GUEST_CR0     0x00006800
#define	GUEST_CR3     0x00006802
#define	GUEST_CR4     0x00006804
#define	GUEST_ES_BASE     0x00006806
#define	GUEST_CS_BASE     0x00006808
#define	GUEST_SS_BASE     0x0000680a
#define	GUEST_DS_BASE     0x0000680c
#define	GUEST_FS_BASE     0x0000680e
#define	GUEST_GS_BASE     0x00006810
#define	GUEST_LDTR_BASE     0x00006812
#define	GUEST_TR_BASE     0x00006814
#define	GUEST_GDTR_BASE     0x00006816
#define	GUEST_IDTR_BASE     0x00006818
#define	GUEST_DR7     0x0000681a
#define	GUEST_RSP     0x0000681c
#define	GUEST_RIP     0x0000681e
#define	GUEST_RFLAGS     0x00006820
#define	GUEST_PENDING_DBG_EXCEPTIONS     0x00006822
#define	GUEST_SYSENTER_ESP     0x00006824
#define	GUEST_SYSENTER_EIP     0x00006826
#define	HOST_CR0     0x00006c00
#define	HOST_CR3     0x00006c02
#define	HOST_CR4     0x00006c04
#define	HOST_FS_BASE     0x00006c06
#define	HOST_GS_BASE     0x00006c08
#define	HOST_TR_BASE     0x00006c0a
#define	HOST_GDTR_BASE     0x00006c0c
#define	HOST_IDTR_BASE     0x00006c0e
#define	HOST_IA32_SYSENTER_ESP     0x00006c10
#define	HOST_IA32_SYSENTER_EIP     0x00006c12
#define	HOST_RSP     0x00006c14
#define	HOST_RIP     0x00006c16

#define MSR_IA32_VMX_BASIC     0x480
#define MSR_IA32_FEATURE_CONTROL     0x03a
#define MSR_IA32_VMX_PINBASED_CTLS    0x48D //0x481
#define MSR_IA32_VMX_PROCBASED_CTLS     0x48E//0x482
#define MSR_IA32_VMX_PROCBASED_CTLS2     0x48b
#define MSR_IA32_VMX_EXIT_CTLS    0x48F// 0x483
#define MSR_IA32_VMX_ENTRY_CTLS    0x490// 0x484
#define IA32_VNX_VMFUNC     0X491


#define MSR_STAR     0xc0000081
#define MSR_LSTAR     0xc0000082
#define MSR_CSTAR     0xc0000083
#define MSR_SYSCALL_MASK     0xc0000084






#define INTERRUPT_EXTERNAL							0
#define INTERRUPT_RESERVED							1
#define INTERRUPT_NMI								2
#define INTERRUPT_HARDWARE_EXCEPTION				3
#define INTERRUPT_SOFTWARE							4
#define INTERRUPT_PRIVILEGED_SOFTWARE_EXCEPTION		5
#define INTERRUPT_SOFTWARE_EXCEPTION				6
#define INTERRUPT_OTHER_EVENT						7


#define VECTOR_DIVIDE_ERROR_EXCEPTION			0
#define VECTOR_DEBUG_EXCEPTION					1
#define VECTOR_NMI_INTERRUPT					2
#define VECTOR_BREAKPOINT_EXCEPTION				3
#define VECTOR_OVERFLOW_EXCEPTION				4
#define VECTOR_BOUND_EXCEPTION					5
#define VECTOR_INVALID_OPCODE_EXCEPTION			6
#define VECTOR_DEVICE_NOT_AVAILABLE_EXCEPTION	7
#define VECTOR_DOUBLE_FAULT_EXCEPTION			8
#define VECTOR_COPROCESSOR_SEGMENT_OVERRUN		9
#define VECTOR_INVALID_TSS_EXCEPTION			10
#define VECTOR_SEGMENT_NOT_PRESENT				11
#define VECTOR_STACK_FAULT_EXCEPTION			12
#define VECTOR_GENERAL_PROTECTION_EXCEPTION		13
#define VECTOR_PAGE_FAULT_EXCEPTION				14
#define VECTOR_X87_FLOATING_POINT_ERROR			16
#define VECTOR_ALIGNMENT_CHECK_EXCEPTION		17
#define VECTOR_MACHINE_CHECK_EXCEPTION			18
#define VECTOR_SIMD_FLOATING_POINT_EXCEPTION	19
#define VECTOR_VIRTUALIZATION_EXCEPTION			20